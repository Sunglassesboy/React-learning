<!DOCTYPE html>
<html>

<head>
  <title>React Basics</title>
  <style>
    body {
      font-family: Arial;
      margin: 0px;

    }

    .send-button {
      background-color: rgb(25, 135, 84);
      color: white;
      padding: 12px 20px;
      margin-left: 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 15px;
    }

    .chat-input {
      padding: 12px;
      border-radius: 10px;
      font-size: 15px;
      border-width: 1px;
      flex-grow: 1;

    }

    .input-container {
      display: flex;
      margin-bottom: 60px;
    }

    .app-container {
      max-width: 700px;
      margin-left: auto;
      margin-right: auto;

      height: 100vh;
      display: flex;
      flex-direction: column;

    }

    .chat-message-user {
      display: flex;
      justify-content: end;
      align-items: center;
    }

    .chat-message-robot {
      display: flex;
      align-items: center;
    }

    .chat-message-text {
      background-color: rgb(233, 233, 233);
      padding: 15px 20px;
      border-radius: 10px;
      margin: 8px 10px;
      max-width: 300px;
    }

    .chat-message-profile {
      width: 45px;
    }

    .chat-messages-component {
      flex-grow: 1;
      margin-top: 15px;
      overflow: scroll;
      scrollbar-width: none;
    }

    .welcome-message {
      text-align: center;

    }

    .loading-icon {
      height: 40px;
      margin: -15px;
    }
  </style>
</head>

<body>
  <div class="js-container"></div>

  <script src="https://unpkg.com/supersimpledev/react.js"></script>
  <script src="https://unpkg.com/supersimpledev/react-dom.js"></script>

  <script src="https://unpkg.com/supersimpledev/chatbot.js"></script>

  <script src="https://unpkg.com/supersimpledev/babel.js"></script>
  <script type="text/babel">

     function useAutoScroll(dependencies) {
        const chatMessagesRef = React.useRef(null);

        React.useEffect(() => {
          const containerElem = chatMessagesRef.current;
          if (containerElem) {
            containerElem.scrollTop = containerElem.scrollHeight;
          }
        }, dependencies)

        return chatMessagesRef;

      }

    //components - Functions - PascleCase Style
    function ChatInput({ chatMessages, setChatMessages }) {
      const [inputText, setInputText] = React.useState('');
      const [isLoading, setIsLoading] = React.useState(false);

      function InputText(event) {
        setInputText(event.target.value);
      }

      async function sendMessage() {
        if (isLoading) return;
        setIsLoading(true);

        //Clear the textBox
        setInputText('');


        //Save user message
        const newChatMessage = [
          ...chatMessages, {
            message: inputText,
            sender: 'user',
            key: crypto.randomUUID()
          }
        ]

        setChatMessages(newChatMessage);
        setChatMessages(
          [
            ...newChatMessage,
            {
              message: <img src="loading-spinner.gif" className="loading-icon" />,
              sender: 'robot',
              key: crypto.randomUUID()
            }
          ]
        )


        //get response and save it
        try {
          const response = await chatbot.getResponseAsync(inputText);
          setChatMessages([
            ...newChatMessage, {
              message: response,
              sender: 'robot',
              key: crypto.randomUUID()
            }
          ])
        } finally {
          setIsLoading(false);
        }

      }

      return (
        <div className='input-container'>
          <input
            placeholder="Send your text to chatBot"
            size="30"
            onChange={InputText}
            value={inputText}
            className='chat-input'

            onKeyDown={(event) => {
              if (event.key === "Enter" && inputText.trim() !== '') {
                sendMessage()
              };
              event.key === "Escape" && setInputText('');
            }}
          />
          <button
            disabled={isLoading || inputText.trim() === ''}
            onClick={sendMessage}
            className='send-button'
          >send</button>
        </div>
      );
    }

    function ChatMessage({ message, sender }) {
      //const message = props.message;
      //const sender = props.sender;

      //2nd Way of destructuring
      // const { message, sender } = props;

      /* if(sender === 'robot'){
         return(
           <div>
             <img src="robot.png" width='40' />
             {message}
           </div>
         )
       } */
      return (
        <div className={sender === "robot" ? 'chat-message-robot' : 'chat-message-user'}>
          {sender === "robot" && (
            <img src='robot.png' className='chat-message-profile' />
          )}
          <div className='chat-message-text'>
            {message}
          </div>
          {sender === "user" && (
            <img src="user.png" className='chat-message-profile' />)}
        </div>
      )
    };

    //fragments <></>
    function ChatMessagesComponent({ chatMessages }) {

      const chatMessagesRef= useAutoScroll(chatMessages);


      return (
        <div className='chat-messages-component' ref={chatMessagesRef}>

          <p className='welcome-message'>
            {chatMessages.length === 0 && "Welcome to the chatbot Project, Send the message using the textbox below"}
          </p>

          {chatMessages.map((message) => {
            return (
              <ChatMessage
                message={message.message}
                sender={message.sender}
              />
            )
          })}
        </div>
      )
    }


    function App() {
      const [chatMessages, setChatMessages] = React.useState([]);

      // const chatMessages = array[0];
      // const setChatMessages = array[1];

      return (
        <div className='app-container'>
          <ChatMessagesComponent chatMessages={chatMessages} />
          <ChatInput chatMessages={chatMessages} setChatMessages={setChatMessages} />
        </div>
      )
    }

    const container = document.querySelector('.js-container');
    ReactDOM.createRoot(container).render(<App />);
  </script>
</body>

</html>